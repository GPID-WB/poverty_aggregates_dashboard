---
title: "Dashboard comparing poverty for various groups"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

<style>
/* Change flexdashboard top bar color */
.navbar.navbar-inverse {
  background-color: #044368 !important;
  border-color: #044368 !important;
}
</style>

```{r setup, include=FALSE}
library(fastverse)
library(ggplot2)
library(shiny)
library(patchwork)
library(wbplot)
```




```{r load-init}
povertylines <- c(3.00, 4.20, 8.30)
path_fst <- fs::path(here::here(), "country_data.fst")
country_data <-
  fst::read_fst(path          = path_fst, 
                as.data.table = TRUE)
source(file = fs::path(here::here(), "utils.R"))
group_choices <- function(var) {
    var  <- underscore_var(var)
    vals <- country_data[[var]]
    vals <- vals[!is.na(vals)]
    sort(funique(vals))
}
```



```{r sidebar}
output$dynamic_sidebar <- renderUI({
  tab <- input$active_tab
  if (is.null(tab)) tab <- "Poverty headcount and the number of poor"

  if (tab == "Poverty headcount and the number of poor") {
    tagList(
      selectInput("group_var1", "Select the group to chart",
                  choices = c("Region (new WB classification)",
                              "Region (old PovcalNet classification)",
                              "Income group (historical)",
                              "Income group (latest)",
                              "FCV (historical)",
                              "FCV (latest)",
                              "IDA (historical)",
                              "IDA (latest)")),
      uiOutput("group0_ui"),

      radioButtons("selected_line",
                   "Select Poverty Line (2021 PPP)",
                   choices  = povertylines,
                   selected = povertylines[1]),
      tags$hr(),
      downloadButton("download_filtered_csv",  "Download CSV",         class = "btn-sm"),
      downloadButton("download_filtered_dta",  "Download Stata (.dta)", class = "btn-sm"),
      downloadButton("download_filtered_excel","Download Excel (.xlsx)",class = "btn-sm")
    )
  }

  else if (tab == "Comparison") {
    tagList(
      selectInput("group_var1",
                  "Select group for figure 1",
                  choices = c("Region (new WB classification)",
                              "Region (old PovcalNet classification)",
                              "Income group (historical)",
                              "Income group (latest)",
                              "FCV (historical)",
                              "FCV (latest)",
                              "IDA (historical)",
                              "IDA (latest)")),
      uiOutput("group1_ui"),

      selectInput("group_var2",
                  "Select group for figure 2",
                  choices = c("Region (new WB classification)",
                              "Region (old PovcalNet classification)",
                              "Income group (historical)",
                              "Income group (latest)",
                              "FCV (historical)",
                              "FCV (latest)",
                              "IDA (historical)",
                              "IDA (latest)")),
      uiOutput("group2_ui"),

      radioButtons("selected_line",
                   "Select Poverty Line",
                   choices  = povertylines,
                   selected = povertylines[1]),
      tags$hr(),
      downloadButton("download_filtered_csv",  "Download CSV",         class = "btn-sm"),
      downloadButton("download_filtered_dta",  "Download Stata (.dta)", class = "btn-sm"),
      downloadButton("download_filtered_excel","Download Excel (.xlsx)",class = "btn-sm")
    )
  }
})

```


```{r output-groupui}
# Tab 1
output$group0_ui <- renderUI({
  req(input$group_var1)
  choices <- group_choices(input$group_var1)
  checkboxGroupInput("group0_values",
                     "Select/deselect",
                     choices  = choices,
                     selected = choices)
})

# Tab 2 - first chart
output$group1_ui <- renderUI({
  req(input$group_var1)
  choices <- group_choices(input$group_var1)
  checkboxGroupInput("group1_values",
                     "Select/deselect",
                     choices = choices,
                     selected = choices)
})

# Tab 2 - second chart
output$group2_ui <- renderUI({
  req(input$group_var2)
  choices <- group_choices(input$group_var2)
  checkboxGroupInput("group2_values",
                     "Select/deselect",
                     choices  = choices,
                     selected = choices)
})

```


```{r filtered-data}
# ---- filtered data for figures ----
filtered_data <- reactive({
  tab <- if (is.null(input$active_tab)) "Poverty headcount and the number of poor" else input$active_tab
  req(input$group_var1, input$selected_line)
  
  # make underscore
  gv1 <- underscore_var(input$group_var1)
  gv2 <- underscore_var(input$group_var2)

  dt <- country_data[poverty_line == as.numeric(input$selected_line)]

  # ---- selections for group_var1
  # On the first tab, use group0 checkboxes; on Comparison, use group1 checkboxes.
  sel_g1 <- if (tab == "Comparison") input$group1_values else input$group0_values
  if (is.null(sel_g1)) sel_g1 <- unique(dt[[input$group_var1]])

  # ---- d0: number of poor (always available; used on first tab)
  d0 <- dt[
    get(gv1) %in% sel_g1,
    .(pop_in_pov = sum(pop_in_pov, na.rm = TRUE)),
    by = c("year", gv1)
  ]

  # ---- d1: poverty rate by group_var1 (used on both tabs)
  d1 <- dt[
    get(gv1) %in% sel_g1,
    .(headcount = weighted.mean(headcount, pop, na.rm = TRUE)),
    by = c("year", gv1)
  ]

  # ---- d2: only needed on Comparison; otherwise return empty DT
  if (tab == "Comparison") {
    req(input$group_var2)
    sel_g2 <- input$group2_values
    if (is.null(sel_g2)) sel_g2 <- unique(dt[[gv2]])
    d2 <- dt[
      get(gv2) %in% sel_g2,
      .(headcount = weighted.mean(headcount, pop, na.rm = TRUE)),
      by = c("year", gv2)
    ]
  } else {
    d2 <- data.table()
  }

  list(graph0 = d0, graph1 = d1, graph2 = d2)
})



```


```{r}
### Download files ###

output$download_filtered <- downloadHandler(
  filename = function() {
    paste0("filtered_data_", Sys.Date(), ".csv")
  },
  content = function(file) {
    tab <- if (is.null(input$active_tab)) "Poverty headcount and the number of poor" else input$active_tab
    data <- if (tab == "Poverty headcount and the number of poor") {
      d1 <- filtered_data()$graph1
      d0 <- filtered_data()$graph0
      gv <- underscore_var(input$group_var1)
      merge(d1, d0, by = c("year", gv), all = TRUE)
    } else {
      d1  <- filtered_data()$graph1
      d2  <- filtered_data()$graph2
      gv1 <- underscore_var(input$group_var1)
      gv2 <- underscore_var(input$group_var2)
      if (nrow(d1)) { d1 <- data.table::copy(d1); data.table::setnames(d1, gv1, "group"); d1[, chart := paste0("Figure 1: ", input$group_var1)] }
      if (nrow(d2)) { d2 <- data.table::copy(d2); data.table::setnames(d2, gv2, "group"); d2[, chart := paste0("Figure 2: ", input$group_var2)] }
      data.table::rbindlist(list(d1, d2), fill = TRUE)
    }
    write.csv(data, file, row.names = FALSE)
  }
)

output$download_filtered_csv <- downloadHandler(
  filename = function() {
    paste0("filtered_data_", Sys.Date(), ".csv")
  },
  content = function(file) {
    tab <- if (is.null(input$active_tab)) "Poverty headcount and the number of poor" else input$active_tab
    data <- if (tab == "Poverty headcount and the number of poor") {
      d1 <- filtered_data()$graph1
      d0 <- filtered_data()$graph0
      gv <- underscore_var(input$group_var1)
      merge(d1, d0, by = c("year", gv), all = TRUE)
    } else {
      d1  <- filtered_data()$graph1
      d2  <- filtered_data()$graph2
      gv1 <- underscore_var(input$group_var1)
      gv2 <- underscore_var(input$group_var2)
      if (nrow(d1)) { d1 <- data.table::copy(d1); data.table::setnames(d1, gv1, "group"); d1[, chart := paste0("Figure 1: ", input$group_var1)] }
      if (nrow(d2)) { d2 <- data.table::copy(d2); data.table::setnames(d2, gv2, "group"); d2[, chart := paste0("Figure 2: ", input$group_var2)] }
      data.table::rbindlist(list(d1, d2), fill = TRUE)
    }
    write.csv(data, file, row.names = FALSE)
  }
)

output$download_filtered_dta <- downloadHandler(
  filename = function() {
    paste0("filtered_data_", Sys.Date(), ".dta")
  },
  content = function(file) {
    tab <- if (is.null(input$active_tab)) "Poverty headcount and the number of poor" else input$active_tab
    data <- if (tab == "Poverty headcount and the number of poor") {
      d1 <- filtered_data()$graph1
      d0 <- filtered_data()$graph0
      gv <- underscore_var(input$group_var1)
      merge(d1, d0, by = c("year", gv), all = TRUE)
    } else {
      d1  <- filtered_data()$graph1
      d2  <- filtered_data()$graph2
      gv1 <- underscore_var(input$group_var1)
      gv2 <- underscore_var(input$group_var2)
      if (nrow(d1)) { d1 <- data.table::copy(d1); data.table::setnames(d1, gv1, "group"); d1[, chart := paste0("Figure 1: ", input$group_var1)] }
      if (nrow(d2)) { d2 <- data.table::copy(d2); data.table::setnames(d2, gv2, "group"); d2[, chart := paste0("Figure 2: ", input$group_var2)] }
      data.table::rbindlist(list(d1, d2), fill = TRUE)
    }
    haven::write_dta(as.data.frame(data), file)
  }
)

output$download_filtered_excel <- downloadHandler(
  filename = function() {
    paste0("filtered_data_", Sys.Date(), ".xlsx")
  },
  content = function(file) {
    tab <- if (is.null(input$active_tab)) "Poverty headcount and the number of poor" else input$active_tab
    data <- if (tab == "Poverty headcount and the number of poor") {
      d1 <- filtered_data()$graph1
      d0 <- filtered_data()$graph0
      gv <- underscore_var(input$group_var1)
      merge(d1, d0, by = c("year", gv), all = TRUE)
    } else {
      d1  <- filtered_data()$graph1
      d2  <- filtered_data()$graph2
      gv1 <- underscore_var(input$group_var1)
      gv2 <- underscore_var(input$group_var2)
      if (nrow(d1)) { d1 <- data.table::copy(d1); data.table::setnames(d1, gv1, "group"); d1[, chart := paste0("Figure 1: ", input$group_var1)] }
      if (nrow(d2)) { d2 <- data.table::copy(d2); data.table::setnames(d2, gv2, "group"); d2[, chart := paste0("Figure 2: ", input$group_var2)] }
      data.table::rbindlist(list(d1, d2), fill = TRUE)
    }
    writexl::write_xlsx(as.data.frame(data), file)
  }
)


# output$download_filtered <- downloadHandler(
#   filename = function() {
#     paste0("filtered_data_", Sys.Date(), ".csv")
#   },
#   content = function(file) {
#     tab <- if (is.null(input$active_tab)) "Poverty headcount and the number of poor" else input$active_tab
#     data <- if (tab == "Poverty headcount and the number of poor") {
#       d1 <- filtered_data()$graph1
#       d0 <- filtered_data()$graph0
#       gv <- underscore_var(input$group_var1)
#       merge(d1, d0, by = c("year", gv), all = TRUE)
#     } else {
#       filtered_data()$graph0
#     }
#     write.csv(data, file, row.names = FALSE)
#   }
# )
# 
# output$download_filtered_csv <- downloadHandler(
#   filename = function() {
#     paste0("filtered_data_", Sys.Date(), ".csv")
#   },
#   content = function(file) {
#     tab <- if (is.null(input$active_tab)) "Poverty headcount and the number of poor" else input$active_tab
#     data <- if (tab == "Poverty headcount and the number of poor") {
#       d1 <- filtered_data()$graph1
#       d0 <- filtered_data()$graph0
#       gv <- underscore_var(input$group_var1)
#       merge(d1, d0, by = c("year", gv), all = TRUE)
#     } else {
#       filtered_data()$graph0
#     }
#     write.csv(data, file, row.names = FALSE)
#   }
# )
# 
# output$download_filtered_dta <- downloadHandler(
#   filename = function() {
#     paste0("filtered_data_", Sys.Date(), ".dta")
#   },
#   content = function(file) {
#     tab <- if (is.null(input$active_tab)) "Poverty headcount and the number of poor" else input$active_tab
#     data <- if (tab == "Poverty headcount and the number of poor") {
#       d1 <- filtered_data()$graph1
#       d0 <- filtered_data()$graph0
#       gv <- underscore_var(input$group_var1)
#       merge(d1, d0, by = c("year", gv), all = TRUE)
#     } else {
#       filtered_data()$graph0
#     }
#     haven::write_dta(as.data.frame(data), file)
#   }
# )
# 
# output$download_filtered_excel <- downloadHandler(
#   filename = function() {
#     paste0("filtered_data_", Sys.Date(), ".xlsx")
#   },
#   content = function(file) {
#     tab <- if (is.null(input$active_tab)) "Poverty headcount and the number of poor" else input$active_tab
#     data <- if (tab == "Poverty headcount and the number of poor") {
#       d1 <- filtered_data()$graph1
#       d0 <- filtered_data()$graph0
#       gv <- underscore_var(input$group_var1)
#       merge(d1, d0, by = c("year", gv), all = TRUE)
#     } else {
#       filtered_data()$graph0
#     }
#     writexl::write_xlsx(as.data.frame(data), file)
#   }
# )

# output$download_filtered <- downloadHandler(
#   filename = function() {
#     paste0("filtered_data_", 
#            Sys.Date(), 
#            ".csv")
#   },
#   content = function(file) {
#     write.csv(filtered_data()$graph0, file)
#   }
# )
# 
# output$download_filtered_csv <- downloadHandler(
#   filename = function() {
#     paste0("filtered_data_", 
#            Sys.Date(), 
#            ".csv")
#   },
#   content = function(file) {
#     write.csv(filtered_data()$graph0, file)
#   }
# )
# 
# output$download_filtered_dta <- downloadHandler(
#   filename = function() {
#     paste0("filtered_data_", Sys.Date(), ".dta")
#   },
#   content = function(file) {
#     haven::write_dta(filtered_data()$graph0, file)
#   }
# )
# 
# output$download_filtered_excel <- downloadHandler(
#   filename = function() {
#     paste0("filtered_data_", Sys.Date(), ".xlsx")
#   },
#   content = function(file) {
#     writexl::write_xlsx(filtered_data()$graph0, file)
#   }
# )

```


Sidebar {.sidebar}
-----------------------------------------------------------------------
```{r}

uiOutput("dynamic_sidebar")

```


Column
-----------------------------------------------------------------------
```{r}
tabsetPanel(
  id   = "active_tab",
  type = "tabs",
  tabPanel("Poverty headcount and the number of poor"),
  tabPanel("Comparison")
)

```


```{r plot-output-mainplot}
plotOutput("main_plot")
```

```{r main-plot-construct}
output$main_plot <- renderPlot({

  d_list <- filtered_data()

  if (input$active_tab == "Poverty headcount and the number of poor") {

    if (fnrow(d_list$graph1) == 0 & fnrow(d_list$graph2) == 0) {
      ggplot() +
        annotate("text",
                 x     = 1,
                 y     = 1,
                 label = "This selection has no data.",
                 size  = 6,
                 hjust = 0.5) +
        theme_void()
    }

    else {
      p1 <- ggplot(d_list$graph1,
                   aes(x     = year,
                       y     = headcount * 100,
                       color = .data[[underscore_var(input$group_var1)]])) +
        geom_line(linewidth = 1) +
        labs(
          title = paste("Poverty rate by", input$group_var1),
          y     = "Poverty headcount, %",
          x     = "") +
        my_theme(by = input$group_var1)


      p2 <- ggplot(d_list$graph0,
                   aes(x    = year,
                       y    = pop_in_pov/1e6,
                       color = .data[[underscore_var(input$group_var1)]])) +
        geom_line(linewidth = 1) +
        labs(
          title = paste("Number of poor by", input$group_var1),
          y = "Millions of poor",
          x = "") +
        my_theme(by = input$group_var1)


      p1 + p2
    }
  } else if (input$active_tab == "Comparison") {


    if (fnrow(d_list$graph1) == 0 & fnrow(d_list$graph2) == 0) {
      ggplot() +
        annotate("text",
                 x     = 1,
                 y     = 1,
                 label = "This selection has no data.",
                 size  = 6,
                 hjust = 0.5) +
        theme_void()
    }

    else {
      p1 <- ggplot(d_list$graph1,
                   aes(x     = year,
                       y     = headcount * 100,
                       color = .data[[underscore_var(input$group_var1)]])) +
        geom_line(linewidth = 1) +
        labs(
          title = paste("Poverty rate by", input$group_var1),
          y     = "Poverty headcount, %",
          x     = "") +
        my_theme(by = input$group_var1) 


      p2 <- ggplot(d_list$graph2,
                   aes(x     = year,
                       y     = headcount * 100,
                       color = .data[[underscore_var(input$group_var2)]])) +
        geom_line(linewidth = 1) +
        labs(
          title = paste("Poverty rate by", input$group_var2),
          y     = "Poverty headcount, %",
          x     = "") +
        my_theme(by = input$group_var2) 

      p1 + p2
    }
  }
})



```



